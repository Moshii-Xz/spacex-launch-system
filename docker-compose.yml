version: "3.9"

services:
  # ── DynamoDB local ──────────────────────────────────────────────────────────
  dynamodb-local:
    image: amazon/dynamodb-local:latest
    container_name: spacex-dynamodb-local
    ports:
      - "8000:8000"
    command: "-jar DynamoDBLocal.jar -sharedDb -inMemory"
    healthcheck:
      test: ["CMD-SHELL", "curl -s http://localhost:8000 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ── Setup tabla DynamoDB local ──────────────────────────────────────────────
  dynamodb-setup:
    image: amazon/aws-cli:latest
    container_name: spacex-dynamodb-setup
    depends_on:
      dynamodb-local:
        condition: service_healthy
    environment:
      AWS_ACCESS_KEY_ID: local
      AWS_SECRET_ACCESS_KEY: local
      AWS_DEFAULT_REGION: us-east-1
    entrypoint: >
      aws dynamodb create-table
        --table-name spacex-launches-dev
        --attribute-definitions
          AttributeName=launch_id,AttributeType=S
          AttributeName=status,AttributeType=S
          AttributeName=launch_date,AttributeType=S
        --key-schema AttributeName=launch_id,KeyType=HASH
        --billing-mode PAY_PER_REQUEST
        --global-secondary-indexes
          "[{\"IndexName\":\"status-index\",\"KeySchema\":[{\"AttributeName\":\"status\",\"KeyType\":\"HASH\"}],\"Projection\":{\"ProjectionType\":\"ALL\"}},
            {\"IndexName\":\"launch_date-index\",\"KeySchema\":[{\"AttributeName\":\"launch_date\",\"KeyType\":\"HASH\"}],\"Projection\":{\"ProjectionType\":\"ALL\"}}]"
        --endpoint-url http://dynamodb-local:8000

  # ── Backend FastAPI ─────────────────────────────────────────────────────────
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: spacex-backend
    ports:
      - "8080:8000"
    environment:
      - AWS_REGION=us-east-1
      - AWS_ACCESS_KEY_ID=local
      - AWS_SECRET_ACCESS_KEY=local
      - DYNAMODB_TABLE=spacex-launches-dev
      - DYNAMODB_ENDPOINT=http://dynamodb-local:8000
      - CORS_ORIGINS=http://localhost:3000
      - LOG_LEVEL=DEBUG
    depends_on:
      dynamodb-local:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 15s
      timeout: 5s
      retries: 5

  # ── WebApp React ────────────────────────────────────────────────────────────
  webapp:
    build:
      context: ./webapp
      target: builder
    container_name: spacex-webapp
    ports:
      - "3000:3000"
    volumes:
      - ./webapp/src:/app/src
    environment:
      - VITE_API_BASE_URL=http://localhost:8080/api/v1
    command: npm run dev -- --host 0.0.0.0
    depends_on:
      backend:
        condition: service_healthy

networks:
  default:
    name: spacex-network
